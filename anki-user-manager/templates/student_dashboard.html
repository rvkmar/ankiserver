{% extends "base.html" %}
{% block content %}
<h2>üìä Stats for {{ student }}</h2>

<div class="row">
  <!-- Card Types -->
  <div class="col-md-6">
    <div class="card mb-4">
      <div class="card-body">
        <h5>Card Types</h5>
        {% if full_stats.card_types %}
        <canvas id="cardTypeChart" height="200"></canvas>
        {% else %}
        <p>No card type data available.</p>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Answer Buttons -->
  <div class="col-md-6">
    <div class="card mb-4">
      <div class="card-body">
        <h5>Answer Buttons</h5>
        {% if full_stats.ease_counts %}
        <canvas id="easeChart" height="200"></canvas>
        {% else %}
        <p>No answer button data available.</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Reviews per Day -->
<div class="card mb-4">
  <div class="card-body">
    <h5>Reviews per Day (last 30 days)</h5>
    {% if full_stats.reviews_per_day %}
    <canvas id="reviewChart" height="120"></canvas>
    {% else %}
    <p>No review history found.</p>
    {% endif %}
  </div>
</div>

<!-- Backlog (Future Due) -->
<div class="card mb-4">
  <div class="card-body">
    <h5>üìÖ Backlog (Future Due Cards, next 30 days)</h5>
    {% if full_stats.future_due %}
    <canvas id="backlogChart" height="120"></canvas>
    {% else %}
    <p>No due cards scheduled.</p>
    {% endif %}
  </div>
</div>

<!-- Intervals Histogram -->
<div class="card mb-4">
  <div class="card-body">
    <h5>‚è≥ Intervals Histogram</h5>
    {% if full_stats.intervals %}
    <canvas id="intervalsChart" height="120"></canvas>
    {% else %}
    <p>No interval data available.</p>
    {% endif %}
  </div>
</div>

<!-- Review Time Chart -->
<div class="card mb-4">
  <div class="card-body">
    <h4>‚è±Ô∏è Review Time (Last 30 Days)</h4>
    <p><strong>Average Review Time per Card:</strong> {{ avg_time }} seconds</p>
    {% if review_time %}
    <canvas id="timeChart" height="120"></canvas>
    {% else %}
    <p>No review time recorded.</p>
    {% endif %}
  </div>
</div>

{% if fsrs_stats %}
<!-- FSRS Metrics -->
<div class="card mb-4">
  <div class="card-body">
    <h5>FSRS Metrics</h5>
    <ul class="list-group">
      <li class="list-group-item">Avg Difficulty: {{ fsrs_stats.avg_difficulty }}</li>
      <li class="list-group-item">Avg Stability (days): {{ fsrs_stats.avg_stability }}</li>
      <li class="list-group-item">Avg Retrievability: {{ (fsrs_stats.avg_retrievability * 100) | round(2) }}%</li>
      <li class="list-group-item">True Retention: {{ fsrs_stats.true_retention }}%</li>
    </ul>
  </div>
</div>
{% endif %}


<!-- üìä Chart -->
<div class="card mx-auto mt-4" style="max-width:900px;">
  <div class="card-body">
    <h4>üìà Due Cards & Reviews Today</h4>
    <canvas id="statsChart" height="120"></canvas>
  </div>
</div>

<!-- Review Trends -->
<div class="card mx-auto mt-4" style="max-width:900px;">
  <div class="card-body">
    <h4>üìà Review Trends (Last 30 days)</h4>
    {% if history %}
    <canvas id="trendChart" height="150"></canvas>
    {% else %}
    <p>No review trends found.</p>
    {% endif %}
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    // --- Bar chart for due/reviews (single student) ---
    const ctx = document.getElementById('statsChart').getContext('2d');
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: ["{{ student }}"],
        datasets: [
          {
            label: 'Due Cards',
            data: [{{ stats.due }}],
        backgroundColor: 'rgba(255, 99, 132, 0.6)'
      },
          {
        label: 'Reviews Today',
        data: [{{ stats.reviews_today }}],
      backgroundColor: 'rgba(54, 162, 235, 0.6)'
          }
        ]
      },
    options: { responsive: true, scales: { y: { beginAtZero: true } } }
    });

  {% if history %}
  // --- Line chart for review history ---
  const trendCtx = document.getElementById('trendChart').getContext('2d');
  new Chart(trendCtx, {
    type: 'line',
    data: {
      labels: [{% for r in history %}"{{ r.day }}",{% endfor %}],
    datasets: [{
      label: "{{ student }}",
      data: [{% for r in history %}{{ r.count }}, {% endfor %}],
    borderColor: 'hsl(210, 70%, 50%)',
    fill: false,
    tension: 0.2
        }]
      },
    options: { responsive: true, scales: { y: { beginAtZero: true } } }
    });
  {% endif %}
  });
</script>

{% if review_time %}
<script>
  // --- Review Time Chart ---
  const timeCtx = document.getElementById('timeChart').getContext('2d');
  new Chart(timeCtx, {
    type: 'line',
    data: {
      labels: [{% for r in review_time %}"{{ r.date }}",{% endfor %}],
    datasets: [{
      label: "Seconds Spent",
      data: [{% for r in review_time %}{{ r.seconds | round(2) }}, {% endfor %}],
    backgroundColor: 'rgba(153, 102, 255, 0.6)',
    borderColor: 'rgba(153, 102, 255, 1)',
    fill: true,
    tension: 0.2
      }]
    },
    options: { responsive: true, scales: { y: { beginAtZero: true } } }
  });
</script>
{% endif %}

{% if full_stats.intervals %}
<script>
  // --- Intervals Histogram ---
  const intervalsCtx = document.getElementById('intervalsChart').getContext('2d');
  new Chart(intervalsCtx, {
    type: 'bar',
    data: {
      labels: [{% for lbl, cnt in full_stats.intervals %}"{{ lbl }}",{% endfor %}],
    datasets: [{ label: "Cards", data: [{% for lbl, cnt in full_stats.intervals %}{{ cnt }}, {% endfor %}], backgroundColor: "rgba(153, 102, 255, 0.6)" }]
    },
    options: { responsive: true, scales: { y: { beginAtZero: true } } }
  });
</script>
{% endif %}

{% if full_stats.future_due %}
<script>
  // --- Backlog (Future Due) ---
  const backlogCtx = document.getElementById('backlogChart').getContext('2d');
  new Chart(backlogCtx, {
    type: 'bar',
    data: {
      labels: [{% for d, c in full_stats.future_due %}"{{ d }}",{% endfor %}],
    datasets: [{ label: "Due Cards", data: [{% for d, c in full_stats.future_due %}{{ c }}, {% endfor %}], backgroundColor: "rgba(75, 192, 192, 0.6)" }]
    },
    options: { responsive: true, scales: { y: { beginAtZero: true } } }
  });
</script>
{% endif %}

{% if full_stats.card_types %}
<script>
  // --- Card Types Pie Chart ---
  const cardTypeCtx = document.getElementById('cardTypeChart').getContext('2d');
  new Chart(cardTypeCtx, {
    type: 'pie',
    data: {
      labels: ["New", "Learning", "Review", "Relearning"],
      datasets: [{
        data: [
          {{ full_stats.card_types.get(0, 0) }},
      {{ full_stats.card_types.get(1, 0) }},
          {{ full_stats.card_types.get(2, 0) }},
    {{ full_stats.card_types.get(3, 0) }}
        ],
    backgroundColor: ['#ff6384', '#36a2eb', '#ffce56', '#4bc0c0']
      }]
    }
  });
</script>
{% endif %}

{% if full_stats.ease_counts %}
<script>
  // --- Answer Buttons Pie Chart ---
  const easeCtx = document.getElementById('easeChart').getContext('2d');
  new Chart(easeCtx, {
    type: 'pie',
    data: {
      labels: ["Again", "Hard", "Good", "Easy"],
      datasets: [{
        data: [
          {{ full_stats.ease_counts.get(1, 0) }},
      {{ full_stats.ease_counts.get(2, 0) }},
          {{ full_stats.ease_counts.get(3, 0) }},
    {{ full_stats.ease_counts.get(4, 0) }}
        ],
    backgroundColor: ['#ff6384', '#ff9f40', '#36a2eb', '#4bc0c0']
      }]
    }
  });
</script>
{% endif %}

{% if full_stats.reviews_per_day %}
<script>
  // --- Reviews per Day (last 30 days) ---
  const reviewCtx = document.getElementById('reviewChart').getContext('2d');
  new Chart(reviewCtx, {
    type: 'line',
    data: {
      labels: [{% for d, c in full_stats.reviews_per_day %}"{{ d }}",{% endfor %}],
    datasets: [{ label: "Reviews", data: [{% for d, c in full_stats.reviews_per_day %}{{ c }}, {% endfor %}], borderColor: "#36a2eb", tension: 0.2 }]
    },
    options: { responsive: true, scales: { y: { beginAtZero: true } } }
  });
</script>
{% endif %}

{% endblock %}