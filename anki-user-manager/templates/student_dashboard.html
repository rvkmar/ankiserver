{% extends "base.html" %}
{% block content %}
<h2>üìä Statistics for {{ student }}</h2>

<!-- Loading placeholder -->
<div id="loading" class="alert alert-info">
  ‚è≥ Loading statistics for {{ student }}...
</div>

<div id="stats-container" class="d-none">
  <!-- ===== Summary ===== -->
  <div class="card mb-4">
    <div class="card-body">
      <h5>üìã Summary</h5>
      <ul>
        <li><strong>Total Cards:</strong> {{ stats.total }}</li>
        <li><strong>Due Cards:</strong> {{ stats.due }}</li>
        <li><strong>Reviews Today:</strong> {{ stats.reviews_today }}</li>
        <li><strong>Average Review Time:</strong> {{ avg_time }} ms</li>
      </ul>
    </div>
  </div>

  <!-- ===== Deck Summary ===== -->
  <div class="card mb-4">
    <div class="card-body">
      <h5>üìö Deck Summary</h5>
      {% if deck_stats %}
      <table class="table table-bordered table-striped">
        <thead class="table-light">
          <tr>
            <th>Deck</th>
            <th>Total Cards</th>
            <th>Due Cards</th>
            <th>Reviews Today</th>
          </tr>
        </thead>
        <tbody>
          {% for d in deck_stats %}
          <tr class="{{ 'total-row' if d.is_total else '' }}">
            <td>{{ d.deck }}</td>
            <td>{{ d.total }}</td>
            <td>{{ d.due }}</td>
            <td>{{ d.reviews_today }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <p>No deck statistics available.</p>
      {% endif %}
    </div>
  </div>

  <!-- ===== Card Types + Answer Buttons ===== -->
  <div class="row">
    <div class="col-md-6">
      <div class="card mb-4">
        <div class="card-body">
          <h5>üóÇÔ∏è Card Types</h5>
          {% if full_stats.card_types %}
          <canvas id="cardTypeChart" height="200"></canvas>
          {% else %}
          <p>No card type data available.</p>
          {% endif %}
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card mb-4">
        <div class="card-body">
          <h5>üîò Answer Buttons</h5>
          {% if full_stats.ease_counts %}
          <canvas id="easeChart" height="200"></canvas>
          {% else %}
          <p>No answer button data available.</p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- ===== Reviews per Day ===== -->
  <div class="card mb-4">
    <div class="card-body">
      <h5>üìÜ Reviews per Day (last 30 days)</h5>
      {% if full_stats.reviews_per_day %}
      <canvas id="reviewChart" height="120"></canvas>
      {% else %}
      <p>No review history found.</p>
      {% endif %}
    </div>
  </div>

  <!-- ===== Future Due (Backlog) ===== -->
  <div class="card mb-4">
    <div class="card-body">
      <h5>üìÖ Backlog (Next 30 days)</h5>
      {% if full_stats.future_due %}
      <canvas id="backlogChart" height="120"></canvas>
      {% else %}
      <p>No due cards scheduled.</p>
      {% endif %}
    </div>
  </div>

  <!-- ===== Intervals ===== -->
  <div class="card mb-4">
    <div class="card-body">
      <h5>‚è≥ Intervals Histogram</h5>
      {% if full_stats.intervals %}
      <canvas id="intervalsChart" height="120"></canvas>
      {% else %}
      <p>No interval data available.</p>
      {% endif %}
    </div>
  </div>

  <!-- ===== Review Time ===== -->
  <div class="card mb-4">
    <div class="card-body">
      <h5>‚è±Ô∏è Review Time (Last 30 Days)</h5>
      <p><strong>Average Review Time per Card:</strong> {{ avg_time }} seconds</p>
      {% if review_time %}
      <canvas id="timeChart" height="120"></canvas>
      {% else %}
      <p>No review time recorded.</p>
      {% endif %}
    </div>
  </div>

  <!-- ===== FSRS Metrics ===== -->
  {% if fsrs_stats %}
  <div class="card mb-4">
    <div class="card-body">
      <h5>‚ö° FSRS Metrics {% if fsrs_stats.is_dummy %}<small class="text-muted">(estimated)</small>{% endif %}</h5>
      <ul class="list-group">
        <li class="list-group-item">Avg Difficulty: {{ fsrs_stats.avg_difficulty }}</li>
        <li class="list-group-item">Avg Stability (days): {{ fsrs_stats.avg_stability }}</li>
        <li class="list-group-item">Avg Retrievability: {{ (fsrs_stats.avg_retrievability * 100) | round(2) }}%</li>
        <li class="list-group-item">True Retention: {{ fsrs_stats.true_retention }}%</li>
      </ul>
    </div>
  </div>
  {% endif %}

  <!-- ===== Due vs Reviews Today ===== -->
  <div class="card mb-4">
    <div class="card-body">
      <h5>üìä Due Cards & Reviews Today</h5>
      <canvas id="statsChart" height="120"></canvas>
    </div>
  </div>

  <!-- ===== Review Trends ===== -->
  <div class="card mb-4">
    <div class="card-body">
      <h5>üìà Review Trends (Last 30 days)</h5>
      {% if history %}
      <canvas id="trendChart" height="150"></canvas>
      {% else %}
      <p>No review trends found.</p>
      {% endif %}
    </div>
  </div>
</div>

<!-- scripts: keep your existing Chart.js blocks as they are -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- lazy load charts after DOM ready -->
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const student = "{{ student }}";

    fetch(`/student_stats/${student}`)
      .then(r => r.json())
      .then(data => {
        document.getElementById("loading").classList.add("d-none");
        document.getElementById("stats-container").classList.remove("d-none");

        if (data.error) {
          document.getElementById("stats-container").innerHTML =
            `<div class="alert alert-danger">‚ö†Ô∏è ${data.error}</div>`;
          return;
        }

        // Example render
        document.getElementById("stats-container").innerHTML = `
        <h4>üìä Summary</h4>
        <ul>
          <li>Total Cards: ${data.stats.total}</li>
          <li>Due Cards: ${data.stats.due}</li>
          <li>Reviews Today: ${data.stats.reviews_today}</li>
          <li>Average Review Time: ${data.avg_time} ms</li>
        </ul>
      `;
      })
      .catch(err => {
        document.getElementById("loading").innerHTML =
          `<div class="alert alert-danger">‚ö†Ô∏è Failed to load stats: ${err}</div>`;
      });
  });
</script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    // --- Bar chart for due/reviews (single student) ---
    const ctx = document.getElementById('statsChart').getContext('2d');
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: ["{{ student }}"],
        datasets: [
          {
            label: 'Due Cards',
            data: [{{ stats.due }}],
        backgroundColor: 'rgba(255, 99, 132, 0.6)'
      },
          {
        label: 'Reviews Today',
        data: [{{ stats.reviews_today }}],
      backgroundColor: 'rgba(54, 162, 235, 0.6)'
          }
        ]
      },
    options: { responsive: true, scales: { y: { beginAtZero: true } } }
    });

  {% if history %}
  // --- Line chart for review history ---
  const trendCtx = document.getElementById('trendChart').getContext('2d');
  new Chart(trendCtx, {
    type: 'line',
    data: {
      labels: [{% for r in history %}"{{ r.day }}",{% endfor %}],
    datasets: [{
      label: "{{ student }}",
      data: [{% for r in history %}{{ r.count }}, {% endfor %}],
    borderColor: 'hsl(210, 70%, 50%)',
    fill: false,
    tension: 0.2
        }]
      },
    options: { responsive: true, scales: { y: { beginAtZero: true } } }
    });
  {% endif %}
  });
</script>

{% if review_time %}
<script>
  // --- Review Time Chart ---
  const timeCtx = document.getElementById('timeChart').getContext('2d');
  new Chart(timeCtx, {
    type: 'line',
    data: {
      labels: [{% for r in review_time %}"{{ r.date }}",{% endfor %}],
    datasets: [{
      label: "Seconds Spent",
      data: [{% for r in review_time %}{{ r.seconds | round(2) }}, {% endfor %}],
    backgroundColor: 'rgba(153, 102, 255, 0.6)',
    borderColor: 'rgba(153, 102, 255, 1)',
    fill: true,
    tension: 0.2
      }]
    },
    options: { responsive: true, scales: { y: { beginAtZero: true } } }
  });
</script>
{% endif %}

{% if full_stats.intervals %}
<script>
  // --- Intervals Histogram ---
  const intervalsCtx = document.getElementById('intervalsChart').getContext('2d');
  new Chart(intervalsCtx, {
    type: 'bar',
    data: {
      labels: [{% for lbl, cnt in full_stats.intervals %}"{{ lbl }}",{% endfor %}],
    datasets: [{ label: "Cards", data: [{% for lbl, cnt in full_stats.intervals %}{{ cnt }}, {% endfor %}], backgroundColor: "rgba(153, 102, 255, 0.6)" }]
    },
    options: { responsive: true, scales: { y: { beginAtZero: true } } }
  });
</script>
{% endif %}

{% if full_stats.future_due %}
<script>
  // --- Backlog (Future Due) ---
  const backlogCtx = document.getElementById('backlogChart').getContext('2d');
  new Chart(backlogCtx, {
    type: 'bar',
    data: {
      labels: [{% for d, c in full_stats.future_due %}"{{ d }}",{% endfor %}],
    datasets: [{ label: "Due Cards", data: [{% for d, c in full_stats.future_due %}{{ c }}, {% endfor %}], backgroundColor: "rgba(75, 192, 192, 0.6)" }]
    },
    options: { responsive: true, scales: { y: { beginAtZero: true } } }
  });
</script>
{% endif %}

{% if full_stats.card_types %}
<script>
  // --- Card Types Pie Chart ---
  const cardTypeCtx = document.getElementById('cardTypeChart').getContext('2d');
  new Chart(cardTypeCtx, {
    type: 'pie',
    data: {
      labels: ["New", "Learning", "Review", "Relearning"],
      datasets: [{
        data: [
          {{ full_stats.card_types.get(0, 0) }},
      {{ full_stats.card_types.get(1, 0) }},
          {{ full_stats.card_types.get(2, 0) }},
    {{ full_stats.card_types.get(3, 0) }}
        ],
    backgroundColor: ['#ff6384', '#36a2eb', '#ffce56', '#4bc0c0']
      }]
    }
  });
</script>
{% endif %}

{% if full_stats.ease_counts %}
<script>
  // --- Answer Buttons Pie Chart ---
  const easeCtx = document.getElementById('easeChart').getContext('2d');
  new Chart(easeCtx, {
    type: 'pie',
    data: {
      labels: ["Again", "Hard", "Good", "Easy"],
      datasets: [{
        data: [
          {{ full_stats.ease_counts.get(1, 0) }},
      {{ full_stats.ease_counts.get(2, 0) }},
          {{ full_stats.ease_counts.get(3, 0) }},
    {{ full_stats.ease_counts.get(4, 0) }}
        ],
    backgroundColor: ['#ff6384', '#ff9f40', '#36a2eb', '#4bc0c0']
      }]
    }
  });
</script>
{% endif %}

{% if full_stats.reviews_per_day %}
<script>
  // --- Reviews per Day (last 30 days) ---
  const reviewCtx = document.getElementById('reviewChart').getContext('2d');
  new Chart(reviewCtx, {
    type: 'line',
    data: {
      labels: [{% for d, c in full_stats.reviews_per_day %}"{{ d }}",{% endfor %}],
    datasets: [{ label: "Reviews", data: [{% for d, c in full_stats.reviews_per_day %}{{ c }}, {% endfor %}], borderColor: "#36a2eb", tension: 0.2 }]
    },
    options: { responsive: true, scales: { y: { beginAtZero: true } } }
  });
</script>
{% endif %}

{% endblock %}