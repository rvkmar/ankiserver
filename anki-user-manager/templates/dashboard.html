{% extends "base.html" %}
{% block content %}
<h2>ðŸ“Š Student Dashboard</h2>

<div class="card mx-auto" style="max-width:900px;">
  <div class="card-body">
    <table class="table table-striped table-bordered">
      <thead class="table-dark">
        <tr>
          <th>Username</th>
          <th>Total Cards</th>
          <th>Due Cards</th>
          <th>Reviews Today</th>
          <th>Details</th>
        </tr>
      </thead>
      <tbody>
        {% for s in stats_list %}
        <tr>
          <td>{{ s.username }}</td>
          <td>{{ s.total_cards }}</td>
          <td>{{ s.due_cards }}</td>
          <td>{{ s.reviews_today }}</td>
          <td>
            <a class="btn btn-sm btn-info" href="{{ url_for('student_dashboard', username=s.username) }}">View</a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- ðŸ“Š Chart -->
<div class="card mx-auto mt-4" style="max-width:900px;">
  <div class="card-body">
    <h4>ðŸ“ˆ Due Cards & Reviews Today</h4>
    <canvas id="statsChart" height="120"></canvas>
  </div>
</div>

<div class="card mx-auto mt-4" style="max-width:900px;">
  <div class="card-body">
    <h4>ðŸ“ˆ Review Trends (Last 14 days)</h4>
    <canvas id="trendChart" height="150"></canvas>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    // --- Bar chart for due/reviews ---
    const ctx = document.getElementById('statsChart').getContext('2d');
    const data = {
      labels: [{% for s in stats_list %}"{{ s.username }}", {% endfor %}],
    datasets: [
    {
      label: 'Due Cards',
      data: [{% for s in stats_list %}{{ s.due_cards }}, {% endfor %}],
    backgroundColor: 'rgba(255, 99, 132, 0.6)'
      },
    {
      label: 'Reviews Today',
      data: [{% for s in stats_list %}{{ s.reviews_today }}, {% endfor %}],
    backgroundColor: 'rgba(54, 162, 235, 0.6)'
      }
    ]
  };
  new Chart(ctx, {
    type: 'bar',
    data: data,
    options: {
      responsive: true,
      plugins: {
        legend: { position: 'top' },
        title: { display: true, text: 'Student Performance Overview' }
      },
      scales: { y: { beginAtZero: true } }
    }
  });

  // --- Line chart for review history ---
  const trendCtx = document.getElementById('trendChart').getContext('2d');
  const trendData = {
    labels: [...new Set([{% for user, rows in history.items() %}{% for r in rows %}"{{ r.date }}", {% endfor %}{% endfor %}])],
  datasets: [
    {% for user, rows in history.items() %}
  {
    label: "{{ user }}",
      data: [{% for r in rows %} { { r.reviews } }, {% endfor %}],
  borderColor: 'hsl({{ loop.index * 70 }}, 70%, 50%)',
    fill: false,
      tension: 0.2
      },
  {% endfor %}
    ]
  };
  new Chart(trendCtx, {
    type: 'line',
    data: trendData,
    options: {
      responsive: true,
      plugins: {
        title: { display: true, text: 'Daily Reviews per Student' }
      },
      scales: { y: { beginAtZero: true } }
    }
  });
});
</script>
{% endblock %}