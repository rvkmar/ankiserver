{% extends "base.html" %}
{% block content %}
<h2>Manage Users</h2>

<!-- Add User Form -->
<form method="POST" action="/add" class="row g-3 mb-4">
  <div class="col-md-4">
    <input type="text" class="form-control" name="username" placeholder="Username" required>
  </div>
  <div class="col-md-4">
    <input type="password" class="form-control" name="password" placeholder="Password" required>
  </div>
  <div class="col-md-4">
    <button type="submit" class="btn btn-primary">Add User</button>
  </div>
</form>

<!-- Users Table -->
<div class="card shadow-sm">
  <div class="card-body p-0">
    <table class="table table-striped table-bordered m-0 align-middle">
      <thead class="table-dark">
        <tr>
          <th>Username</th>
          <th>Password</th>
          <th class="text-center">Actions</th>
        </tr>
      </thead>
      <tbody>
      {% for user, password in users %}
        <tr>
          <td class="username">{{ user }}</td>
          <td>
            <span class="password-mask">********</span>
            <span class="password-real d-none">{{ password }}</span>
            <button type="button" class="btn btn-sm btn-outline-secondary float-end toggle-pass">
              <i class="bi bi-eye"></i>
            </button>
          </td>
          <td class="text-center">
            <!-- Edit -->
            <button type="button" class="btn btn-sm btn-outline-primary edit-user">
              <i class="bi bi-pencil"></i>
            </button>
            <!-- Delete -->
            <button type="button" class="btn btn-sm btn-outline-danger" 
                    data-bs-toggle="modal" 
                    data-bs-target="#deleteModal" 
                    data-username="{{ user }}">
              <i class="bi bi-trash"></i>
            </button>
          </td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="deleteModalLabel">Confirm Delete</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        Are you sure you want to delete <strong id="delete-username"></strong>?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
      </div>
    </div>
  </div>
</div>

<!-- <script>
// Toggle password visibility
document.querySelectorAll(".toggle-pass").forEach(btn => {
  btn.addEventListener("click", () => {
    const row = btn.closest("td");
    const mask = row.querySelector(".password-mask");
    const real = row.querySelector(".password-real");
    const icon = btn.querySelector("i");

    if (mask.classList.contains("d-none")) {
      mask.classList.remove("d-none");
      real.classList.add("d-none");
      icon.classList.remove("bi-eye-slash");
      icon.classList.add("bi-eye");
    } else {
      mask.classList.add("d-none");
      real.classList.remove("d-none");
      icon.classList.remove("bi-eye");
      icon.classList.add("bi-eye-slash");
    }
    // mask.classList.toggle("d-none");
    // real.classList.toggle("d-none");
    // icon.classList.toggle("bi-eye");
    // icon.classList.toggle("bi-eye-slash");
  });
});

// Inline edit (username & password)
document.querySelectorAll(".edit-user").forEach(btn => {
  btn.addEventListener("click", () => {
    const row = btn.closest("tr");
    const usernameCell = row.querySelector(".username");
    const passMask = row.querySelector(".password-mask");
    const passReal = row.querySelector(".password-real");
    const actionsCell = row.querySelector("td:last-child");

    const currentUser = usernameCell.innerText.trim();
    const currentPass = passReal.innerText.trim();

    // Replace with input fields
    usernameCell.innerHTML = `<input type="text" class="form-control form-control-sm" value="${currentUser}">`;
    passMask.remove();
    passReal.remove();
    row.querySelector(".toggle-pass").remove();

    row.children[1].innerHTML = `
      <input type="password" class="form-control form-control-sm" value="${currentPass}">
    `;

    // Replace actions with Save/Cancel
    actionsCell.innerHTML = `
      <button type="button" class="btn btn-sm btn-success save-user">Save</button>
      <button type="button" class="btn btn-sm btn-secondary cancel-edit">Cancel</button>
    `;

    // Save handler
    actionsCell.querySelector(".save-user").addEventListener("click", () => {
      const newUser = usernameCell.querySelector("input").value;
      const newPass = row.children[1].querySelector("input").value;

      fetch("/delete", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: `username=${encodeURIComponent(currentUser)}`
      }).then(() => {
        fetch("/add", {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: `username=${encodeURIComponent(newUser)}&password=${encodeURIComponent(newPass)}`
        }).then(() => location.reload());
      });
    });

    // Cancel handler
    actionsCell.querySelector(".cancel-edit").addEventListener("click", () => location.reload());
  });
});

// Delete modal handling
let deleteUser = "";
const deleteModal = document.getElementById("deleteModal");
deleteModal.addEventListener("show.bs.modal", function (event) {
  const button = event.relatedTarget;
  deleteUser = button.getAttribute("data-username");
  document.getElementById("delete-username").textContent = deleteUser;
});

document.getElementById("confirmDeleteBtn").addEventListener("click", function () {
  fetch("/delete", {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body: `username=${encodeURIComponent(deleteUser)}`
  }).then(() => location.reload());
});
</script> -->
<script>
  // Toggle password visibility
  function bindToggleEvents() {
    document.querySelectorAll(".toggle-pass").forEach(btn => {
      btn.onclick = () => {
        const row = btn.closest("td");
        const mask = row.querySelector(".password-mask");
        const real = row.querySelector(".password-real");
        const icon = btn.querySelector("i");

        if (!mask || !real) return; // skip if editing

        if (mask.classList.contains("d-none")) {
          mask.classList.remove("d-none");
          real.classList.add("d-none");
          icon.classList.remove("bi-eye-slash");
          icon.classList.add("bi-eye");
        } else {
          mask.classList.add("d-none");
          real.classList.remove("d-none");
          icon.classList.remove("bi-eye");
          icon.classList.add("bi-eye-slash");
        }
      };
    });
  }
  bindToggleEvents();

  // Inline edit (username & password)
  document.querySelectorAll(".edit-user").forEach(btn => {
    btn.addEventListener("click", () => {
      const row = btn.closest("tr");
      const usernameCell = row.querySelector(".username");
      const passMask = row.querySelector(".password-mask");
      const passReal = row.querySelector(".password-real");
      const toggleBtn = row.querySelector(".toggle-pass");
      const actionsCell = row.querySelector("td:last-child");

      const currentUser = usernameCell.innerText.trim();
      const currentPass = passReal.innerText.trim();

      // Replace with input fields
      usernameCell.innerHTML = `<input type="text" class="form-control form-control-sm" value="${currentUser}">`;

      row.children[1].innerHTML = `
      <div class="position-relative">
        <input type="password" class="form-control form-control-sm pwd-input" value="${currentPass}" style="padding-right:2rem;">
        <button type="button" class="btn btn-sm btn-outline-secondary toggle-pass" 
                style="position:absolute; right:0.25rem; top:50%; transform:translateY(-50%);">
          <i class="bi bi-eye"></i>
        </button>
      </div>
    `;

      // Replace actions with Save/Cancel
      actionsCell.innerHTML = `
      <button type="button" class="btn btn-sm btn-success save-user">Save</button>
      <button type="button" class="btn btn-sm btn-secondary cancel-edit">Cancel</button>
    `;

      // Bind new eye toggle for the edit input
      const newToggle = row.querySelector(".toggle-pass");
      const pwdInput = row.querySelector(".pwd-input");
      newToggle.onclick = () => {
        const icon = newToggle.querySelector("i");
        if (pwdInput.type === "password") {
          pwdInput.type = "text";
          icon.classList.remove("bi-eye");
          icon.classList.add("bi-eye-slash");
        } else {
          pwdInput.type = "password";
          icon.classList.remove("bi-eye-slash");
          icon.classList.add("bi-eye");
        }
      };

      // Save handler
      actionsCell.querySelector(".save-user").addEventListener("click", () => {
        const newUser = usernameCell.querySelector("input").value;
        const newPass = pwdInput.value;

        fetch("/delete", {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: `username=${encodeURIComponent(currentUser)}`
        }).then(() => {
          fetch("/add", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: `username=${encodeURIComponent(newUser)}&password=${encodeURIComponent(newPass)}`
          }).then(() => location.reload());
        });
      });

      // Cancel handler
      actionsCell.querySelector(".cancel-edit").addEventListener("click", () => location.reload());
    });
  });

  // Delete modal handling
  let deleteUser = "";
  const deleteModal = document.getElementById("deleteModal");
  deleteModal.addEventListener("show.bs.modal", function (event) {
    const button = event.relatedTarget;
    deleteUser = button.getAttribute("data-username");
    document.getElementById("delete-username").textContent = deleteUser;
  });

  document.getElementById("confirmDeleteBtn").addEventListener("click", function () {
    fetch("/delete", {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: `username=${encodeURIComponent(deleteUser)}`
    }).then(() => location.reload());
  });
</script>

{% endblock %}

