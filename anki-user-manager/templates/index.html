{% extends "base.html" %}
{% block content %}
<h2>Manage Users</h2>
<form method="POST" action="/add" class="row g-3 mb-4">
  <div class="col-md-4">
    <input type="text" class="form-control" name="username" placeholder="Username" required>
  </div>
  <div class="col-md-4">
    <input type="password" class="form-control" name="password" placeholder="Password" required>
  </div>
  <div class="col-md-4">
    <button type="submit" class="btn btn-primary">Add User</button>
  </div>
</form>

<table class="table table-striped table-bordered align-middle">
  <thead class="table-dark">
    <tr><th>Username</th><th>Password</th><th>Actions</th></tr>
  </thead>
  <tbody>
  {% for user, password in users %}
    <tr>
      <td>{{ user }}</td>
        <!-- Default: masked password + eye toggle -->
	<td class="d-flex justify-content-between align-items-center">
	  <div>
	    <span class="password-mask">********</span>
	    <span class="password-real d-none">{{ password }}</span>
	  </div>
	  <button type="button" class="btn btn-sm btn-outline-secondary toggle-pass ms-2">
	    <i class="bi bi-eye"></i>
	  </button>
	</td>

	<td>
        <!-- Edit + Delete buttons -->
        <button type="button" class="btn btn-sm btn-warning" onclick="enableEdit(this)">
          <i class="bi bi-pencil"></i>
        </button>
        <button type="button" class="btn btn-sm btn-success d-none" onclick="saveEdit(this)">
          ✅
        </button>
        <button type="button" class="btn btn-sm btn-secondary d-none" onclick="cancelEdit(this)">
          ❌
        </button>
      <button type="button" class="btn btn-sm btn-danger" 
        data-bs-toggle="modal" 
        data-bs-target="#deleteModal" 
        data-username="{{ user }}"><i class="bi bi-trash"></i></button>
      </td>
    </tr>
  {% endfor %}
  </tbody>
</table>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="deleteModalLabel">Confirm Delete</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        Are you sure you want to delete <strong id="delete-username"></strong>?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
      </div>
    </div>
  </div>
</div>


<script>
// Toggle eye button (before edit mode)
document.addEventListener("click", function(e) {
  if (e.target.closest(".toggle-pass")) {
    const td = e.target.closest("td");
    const mask = td.querySelector(".password-mask");
    const real = td.querySelector(".password-real");
    const icon = td.querySelector("i");

    if (mask.classList.contains("d-none")) {
      mask.classList.remove("d-none");
      real.classList.add("d-none");
      icon.classList.remove("bi-eye-slash");
      icon.classList.add("bi-eye");
    } else {
      mask.classList.add("d-none");
      real.classList.remove("d-none");
      icon.classList.remove("bi-eye");
      icon.classList.add("bi-eye-slash");
    }
  }
});

// Enable inline edit
function enableEdit(btn) {
  const row = btn.closest("tr");
  const usernameCell = row.cells[0];
  const passwordCell = row.cells[1];

  usernameCell.dataset.original = usernameCell.innerText.trim();
  passwordCell.dataset.original = passwordCell.querySelector(".password-real").innerText.trim();

  usernameCell.innerHTML = `<input type="text" class="form-control form-control-sm" value="${usernameCell.dataset.original}">`;

  passwordCell.innerHTML = `
	<div class="d-flex justify-content-between align-items-center">
	    <input type="password" class="form-control form-control-sm w-75" value="${passwordCell.querySelector('.password-real').innerText}">
	    <button type="button" class="btn btn-sm btn-outline-secondary toggle-pass ms-2">
	      <i class="bi bi-eye"></i>
	    </button>
	</div>
  `;

  // Eye toggle for inline edit
  passwordCell.querySelector(".toggle-pass").addEventListener("click", function() {
    const input = passwordCell.querySelector("input");
    const icon = this.querySelector("i");
    if (input.type === "password") {
      input.type = "text";
      icon.classList.remove("bi-eye");
      icon.classList.add("bi-eye-slash");
    } else {
      input.type = "password";
      icon.classList.remove("bi-eye-slash");
      icon.classList.add("bi-eye");
    }
  });

  btn.classList.add("d-none");
  row.querySelector(".btn-success").classList.remove("d-none");
  row.querySelector(".btn-secondary").classList.remove("d-none");
}

// Save edit
function saveEdit(btn) {
  const row = btn.closest("tr");
  const usernameCell = row.cells[0];
  const passwordCell = row.cells[1];

  const newUsername = usernameCell.querySelector("input").value;
  const newPassword = passwordCell.querySelector("input").value;
  const oldUsername = usernameCell.dataset.original;

  fetch("/edit", {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body: `old_username=${encodeURIComponent(oldUsername)}&new_username=${encodeURIComponent(newUsername)}&new_password=${encodeURIComponent(newPassword)}`
  }).then(res => {
    if (res.ok) location.reload();
    else alert("Failed to edit user");
  });
}

// Cancel edit
function cancelEdit(btn) {
  const row = btn.closest("tr");
  const usernameCell = row.cells[0];
  const passwordCell = row.cells[1];

  usernameCell.innerText = usernameCell.dataset.original;
  passwordCell.innerHTML = `
    <span class="password-mask">********</span>
    <span class="password-real d-none">${passwordCell.dataset.original}</span>
    <button type="button" class="btn btn-sm btn-outline-secondary toggle-pass">
      <i class="bi bi-eye"></i>
    </button>
  `;

  btn.classList.add("d-none");
  row.querySelector(".btn-success").classList.add("d-none");
  row.querySelector(".btn-warning").classList.remove("d-none");
}

// Delete with confirmation
function confirmDelete(username) {
  if (confirm(`Delete user "${username}"?`)) {
    fetch("/delete", {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: `username=${encodeURIComponent(username)}`
    }).then(() => location.reload());
  }
}
</script>
<script>
// Handle delete modal
let deleteUser = "";

const deleteModal = document.getElementById("deleteModal");
deleteModal.addEventListener("show.bs.modal", function (event) {
  const button = event.relatedTarget;
  deleteUser = button.getAttribute("data-username");
  document.getElementById("delete-username").textContent = deleteUser;
});

document.getElementById("confirmDeleteBtn").addEventListener("click", function () {
  fetch("/delete", {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body: `username=${encodeURIComponent(deleteUser)}`
  }).then(() => location.reload());
});
</script>

{% endblock %}

