{% extends "base.html" %}
{% block content %}
<h2>üìä Stats for {{ student }}</h2>

<div class="row">
  <!-- Card Types -->
  <div class="col-md-6">
    <div class="card mb-4">
      <div class="card-body">
        <h5>Card Types</h5>
        <canvas id="cardTypeChart" height="200"></canvas>
      </div>
    </div>
  </div>

  <!-- Answer Buttons -->
  <div class="col-md-6">
    <div class="card mb-4">
      <div class="card-body">
        <h5>Answer Buttons</h5>
        <canvas id="easeChart" height="200"></canvas>
      </div>
    </div>
  </div>
</div>

<!-- Reviews per Day -->
<div class="card mb-4">
  <div class="card-body">
    <h5>Reviews per Day (last 30 days)</h5>
    <canvas id="reviewChart" height="120"></canvas>
  </div>
</div>

<!-- Backlog (Future Due) -->
<div class="card mb-4">
  <div class="card-body">
    <h5>üìÖ Backlog (Future Due Cards, next 30 days)</h5>
    <canvas id="backlogChart" height="120"></canvas>
  </div>
</div>

<!-- Intervals Histogram -->
<div class="card mb-4">
  <div class="card-body">
    <h5>‚è≥ Intervals Histogram</h5>
    <canvas id="intervalsChart" height="120"></canvas>
  </div>
</div>

<!-- Review Time Chart -->
<div class="card mb-4">
  <div class="card-body">
    <h4>‚è±Ô∏è Review Time (Last 30 Days)</h4>
    <p><strong>Average Review Time per Card:</strong> {{ avg_time }} seconds</p>
    <canvas id="timeChart" height="120"></canvas>
  </div>
</div>

<!-- FSRS Metrics -->
<div class="card mb-4">
  <div class="card-body">
    <h5>FSRS Metrics</h5>
    {% if fsrs_stats %}
    <ul class="list-group">
      <li class="list-group-item">Avg Difficulty: {{ fsrs_stats.avg_difficulty }}</li>
      <li class="list-group-item">Avg Stability (days): {{ fsrs_stats.avg_stability }}</li>
      <li class="list-group-item">Avg Retrievability: {{ fsrs_stats.avg_retrievability * 100 }}%</li>
      <li class="list-group-item">True Retention: {{ fsrs_stats.true_retention }}%</li>
    </ul>
    {% else %}
    <p>No FSRS stats available.</p>
    {% endif %}
  </div>
</div>

<!-- üìä Chart -->
<div class="card mx-auto mt-4" style="max-width:900px;">
  <div class="card-body">
    <h4>üìà Due Cards & Reviews Today</h4>
    <canvas id="statsChart" height="120"></canvas>
  </div>
</div>

<div class="card mx-auto mt-4" style="max-width:900px;">
  <div class="card-body">
    <h4>üìà Review Trends (Last 14 days)</h4>
    <canvas id="trendChart" height="150"></canvas>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    // --- Bar chart for due/reviews ---
    const ctx = document.getElementById('statsChart').getContext('2d');
    const data = {
      labels: [{% for s in stats_list %}"{{ s.username }}", {% endfor %}],
    datasets: [
    {
      label: 'Due Cards',
      data: [{% for s in stats_list %}{{ s.due_cards }}, {% endfor %}],
    backgroundColor: 'rgba(255, 99, 132, 0.6)'
      },
    {
      label: 'Reviews Today',
      data: [{% for s in stats_list %}{{ s.reviews_today }}, {% endfor %}],
    backgroundColor: 'rgba(54, 162, 235, 0.6)'
      }
    ]
  };
  new Chart(ctx, {
    type: 'bar',
    data: data,
    options: {
      responsive: true,
      plugins: {
        legend: { position: 'top' },
        title: { display: true, text: 'Student Performance Overview' }
      },
      scales: { y: { beginAtZero: true } }
    }
  });

  // --- Line chart for review history ---
  const trendCtx = document.getElementById('trendChart').getContext('2d');
  const trendData = {
    labels: [...new Set([{% for user, rows in history.items() %}{% for r in rows %}"{{ r.date }}", {% endfor %}{% endfor %}])],
  datasets: [
    {% for user, rows in history.items() %}
  {
    label: "{{ user }}",
      data: [{% for r in rows %} { { r.reviews } }, {% endfor %}],
  borderColor: 'hsl({{ loop.index * 70 }}, 70%, 50%)',
    fill: false,
      tension: 0.2
      },
  {% endfor %}
    ]
  };
  new Chart(trendCtx, {
    type: 'line',
    data: trendData,
    options: {
      responsive: true,
      plugins: {
        title: { display: true, text: 'Daily Reviews per Student' }
      },
      scales: { y: { beginAtZero: true } }
    }
  });
});
</script>

<script>
  const timeCtx = document.getElementById('timeChart').getContext('2d');

  const timeData = {
    labels: [{% for r in review_time %}"{{ r.date }}", {% endfor %}],
  datasets: [{
    label: "Seconds Spent",
    data: [{% for r in review_time %}{{ r.seconds | round(2) }}, {% endfor %}],
    backgroundColor: 'rgba(153, 102, 255, 0.6)',
      borderColor: 'rgba(153, 102, 255, 1)',
        borderWidth: 2,
          fill: true,
            tension: 0.2
    }]
  };

  new Chart(timeCtx, {
    type: 'line',
    data: timeData,
    options: {
      responsive: true,
      plugins: {
        title: { display: true, text: 'Review Time per Day (seconds)' }
      },
      scales: {
        y: { beginAtZero: true }
      }
    }
  });
</script>


<script>
  // --- Intervals Histogram ---
  const intervalsCtx = document.getElementById('intervalsChart').getContext('2d');
  new Chart(intervalsCtx, {
    type: 'bar',
    data: {
      labels: [{% for lbl, cnt in full_stats.intervals %}"{{ lbl }}",{% endfor %}],
    datasets: [{
      label: "Cards",
      data: [{% for lbl, cnt in full_stats.intervals %}{{ cnt }}, {% endfor %}],
    backgroundColor: "rgba(153, 102, 255, 0.6)"
    }]
  },
    options: {
    responsive: true,
    plugins: {
      title: { display: true, text: "Card Distribution by Interval" }
    },
    scales: {
      y: { beginAtZero: true }
    }
  }
});
</script>

<script>
  // --- Backlog (Future Due) ---
  const backlogCtx = document.getElementById('backlogChart').getContext('2d');
  new Chart(backlogCtx, {
    type: 'bar',
    data: {
      labels: [{% for d, c in full_stats.future_due %}"{{ d }}",{% endfor %}],
    datasets: [{
      label: "Due Cards",
      data: [{% for d, c in full_stats.future_due %}{{ c }}, {% endfor %}],
    backgroundColor: "rgba(75, 192, 192, 0.6)"
    }]
  },
    options: {
    responsive: true,
    scales: { y: { beginAtZero: true } },
    plugins: {
      title: { display: true, text: "Future Scheduled Cards" }
    }
  }
});
</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // --- Card Types Pie Chart ---
  const cardTypeCtx = document.getElementById('cardTypeChart').getContext('2d');
  new Chart(cardTypeCtx, {
    type: 'pie',
    data: {
      labels: ["New", "Learning", "Review", "Relearning"],
      datasets: [{
        data: [
          {{ full_stats.card_types.get(0, 0) }},
      {{ full_stats.card_types.get(1, 0) }},
        {{ full_stats.card_types.get(2, 0) }},
    {{ full_stats.card_types.get(3, 0) }}
      ],
    backgroundColor: ['#ff6384', '#36a2eb', '#ffce56', '#4bc0c0']
    }]
  },
    options: { responsive: true }
});

  // --- Answer Buttons Pie Chart ---
  const easeCtx = document.getElementById('easeChart').getContext('2d');
  new Chart(easeCtx, {
    type: 'pie',
    data: {
      labels: ["Again", "Hard", "Good", "Easy"],
      datasets: [{
        data: [
          {{ full_stats.ease_counts.get(1, 0) }},
      {{ full_stats.ease_counts.get(2, 0) }},
        {{ full_stats.ease_counts.get(3, 0) }},
    {{ full_stats.ease_counts.get(4, 0) }}
      ],
    backgroundColor: ['#ff6384', '#ff9f40', '#36a2eb', '#4bc0c0']
    }]
  },
    options: { responsive: true }
});

  // --- Reviews per Day (last 30 days) ---
  const reviewCtx = document.getElementById('reviewChart').getContext('2d');
  new Chart(reviewCtx, {
    type: 'line',
    data: {
      labels: [{% for d, c in full_stats.reviews_per_day %}"{{ d }}",{% endfor %}],
    datasets: [{
      label: "Reviews",
      data: [{% for d, c in full_stats.reviews_per_day %}{{ c }}, {% endfor %}],
    borderColor: "#36a2eb",
    fill: true,
    tension: 0.2
    }]
  },
    options: {
    responsive: true,
    scales: { y: { beginAtZero: true } }
  }
});
</script>
{% endblock %}